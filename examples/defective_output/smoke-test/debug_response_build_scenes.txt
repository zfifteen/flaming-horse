from pathlib import Path

from manim import *
import numpy as np
from manim_voiceover_plus import VoiceoverScene

from flaming_horse_voice import get_speech_service
from flaming_horse.scene_helpers import safe_position, harmonious_color, polished_fade_in, adaptive_title_position, safe_layout, BeatPlan, play_next, play_text_next
from narration_script import SCRIPT

# LOCKED CONFIGURATION (DO NOT MODIFY)
config.frame_height = 10
config.frame_width = 10 * 16 / 9
config.pixel_height = 1440
config.pixel_width = 2560

class Scene01Intro(VoiceoverScene):
    def construct(self):
        ref_path = Path("assets/voice_ref/ref.wav")
        if not ref_path.exists():
            raise FileNotFoundError("Run precache_voice.sh before building.")

        self.set_speech_service(get_speech_service(Path(__file__).resolve().parent))

        with self.voiceover(text=SCRIPT["scene_01_intro"]) as tracker:
            # SLOT_START_SCENE_BODY
            num_beats = max(12, min(30, int(np.ceil(tracker.duration / 1.8))))
            beats = BeatPlan(tracker.duration, [1] * num_beats)  # Uniform weights

            # Title
            blues = harmonious_color(BLUE, variations=3)
            title = Text("Awakening to Reality", font_size=48, weight=BOLD, color=blues[0])
            title.move_to(UP * 3.8)
            play_text_next(self, beats, Write(title))

            # Subtitle
            subtitle = Text("Questioning the Nature of Reality", font_size=32, color=blues[1])
            subtitle.next_to(title, DOWN, buff=0.4)
            safe_position(subtitle)
            play_text_next(self, beats, polished_fade_in(subtitle, lag_ratio=0.1))

            # Progressive bullets
            bullet_1 = Text("What is real?", font_size=28, color=blues[2]).move_to(LEFT * 3.5 + UP * 1.5)
            bullet_1.set_max_width(6.0)
            bullet_2 = Text("The choice awaits", font_size=28, color=blues[2]).next_to(bullet_1, DOWN, aligned_edge=LEFT, buff=0.3)
            safe_position(bullet_2)
            bullet_2.set_max_width(6.0)

            # Central reality illusion diagram: simple grid
            grid = NumberPlane(x_range=[-5, 5], y_range=[-3, 3], axis_config={"color": GRAY}, background_line_style={"stroke_color": GRAY, "stroke_width": 1}).move_to(DOWN * 0.6)
            mirror_effect = Rectangle(width=4, height=2, fill_opacity=0.3, fill_color=WHITE, stroke_color=WHITE).move_to(grid.get_center())

            play_text_next(self, beats, FadeIn(bullet_1))
            play_text_next(self, beats, FadeIn(bullet_2))
            play_next(self, beats, FadeIn(grid), FadeIn(mirror_effect))

            # Cleanup before evolving visual
            play_next(self, beats, FadeOut(subtitle), FadeOut(bullet_1), FadeOut(bullet_2))

            # Right-side visual: blurred matrix code background, sharpen to pill icon
            matrix_bg = Rectangle(width=5, height=4, fill_opacity=0.5, fill_color=GREEN, stroke_color=GREEN).move_to(RIGHT * 3 + DOWN * 0.6)
            matrix_text = Text("010101\n101010\n010101", font_size=20, color=GREEN).move_to(matrix_bg.get_center())
            pill_icon = Circle(radius=0.5, fill_color=RED, stroke_color=RED).move_to(matrix_bg.get_center() + UP * 0.5)
            pill_label = Text("Red Pill", font_size=18, color=RED).next_to(pill_icon, DOWN, buff=0.1)
            safe_position(pill_label)

            play_next(self, beats, FadeIn(matrix_bg), FadeIn(matrix_text))
            play_next(self, beats, Transform(matrix_text, pill_icon), FadeOut(matrix_bg))
            play_next(self, beats, FadeIn(pill_label))

            # Final fade out
            play_next(self, beats, FadeOut(title), FadeOut(grid), FadeOut(mirror_effect), FadeOut(pill_icon), FadeOut(pill_label))
            # SLOT_END_SCENE_BODY