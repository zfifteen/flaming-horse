# Deterministic `project_state.json` (Permanent Fix)

This repo originally relied on the LLM agent to edit `project_state.json` during each phase.
In practice, the agent occasionally produced malformed JSON or partial edits that resulted in:

- `JSONDecodeError: Extra data` (duplicate JSON blocks appended)
- missing keys (for example `KeyError: 'flags'`), because the corrupted state got truncated
  at an arbitrary point.

These failures are intermittent by nature (model output + edit tool behavior), which made them
repeat over and over even after adding “repair” logic.

This document describes the permanent fix: **the agent no longer owns the state file**.

---

## Root Cause

The agent was using a patch-style “Edit” operation on `project_state.json`.
When that edit went wrong, it could:

1. Append duplicated JSON fragments after a valid closing brace (`}`), creating trailing
   garbage.
2. Produce a structurally invalid or incomplete object (missing required keys such as
   `flags`).

Even if a best-effort “truncate trailing data” repair is applied, you can still end up with a
valid JSON object that is **missing required fields**.

Therefore, the correct fix is not to “repair” arbitrary model edits—it is to make the state
file deterministic and generated by code.

---

## New Architecture

### Principle

**`project_state.json` is owned by the pipeline scripts, not by the agent.**

The agent is only responsible for generating phase artifacts:

- `plan.json`
- `narration_script.py`
- `scene_*.py`

The build pipeline reads those artifacts and deterministically updates `project_state.json`.

Important: the agent prompt explicitly tells the model to NOT edit `project_state.json`.

### New Script: `scripts/update_project_state.py`

`scripts/update_project_state.py` is now the single authority for:

- reading state with best-effort recovery
- normalizing state to the required schema
- deterministically advancing phases based on artifacts on disk

Supported modes:

- `--mode normalize`
  - repairs JSON if trailing garbage exists
  - rewrites the file with all required fields (`flags` included)
  - clamps indices, coerces types

- `--mode apply --phase <phase>`
  - applies deterministic transitions based on what exists on disk
  - example: after `plan` phase, read `plan.json`, derive `scenes`, set `phase=review`

### State Schema

`scripts/state_schema.json` documents the minimum required shape.
The normalization step ensures these required top-level fields always exist.

---

## Pipeline Changes (`scripts/build_video.sh`)

### 1) Always normalize state before reading it

At the start of each loop iteration, the pipeline now runs:

```
python3 scripts/update_project_state.py --project-dir <dir> --mode normalize
```

This guarantees:

- the JSON parses
- required keys exist

### 2) Deterministic state updates after every phase

After each phase handler returns, the pipeline runs:

```
python3 scripts/update_project_state.py --project-dir <dir> --mode apply --phase <phase>
```

This step ignores any agent-provided edits to `project_state.json` and recomputes the next
state from artifacts.

### 3) Review phase no longer uses the agent

The “review” phase is now a deterministic check of `plan.json` structure + transition to
`narration`.

---

## What This Fix Guarantees

- `project_state.json` remains valid JSON even if the agent emits garbage.
- Required fields (`flags`, `errors`, `history`, etc.) are always present.
- Phase transitions no longer depend on the agent editing state correctly.
- The pipeline can’t crash with `KeyError: 'flags'` from a truncated/broken state.

What it does *not* guarantee:

- That the agent generates correct `plan.json` or scene code.
  - Those are still validated separately and will fail with actionable errors.

---

## How To Test

### Unit-ish tests (no Manim, no TTS)

Run the deterministic state manager tests:

```
python3 scripts/test_update_project_state.py
```

### Fast structural test

1. Create a project:

```
./scripts/create_video.sh test-determinism --topic "Test"
```

2. Corrupt state deliberately:

```
echo "\nTHIS IS GARBAGE" >> projects/test-determinism/project_state.json
```

3. Run the builder:

```
./scripts/build_video.sh projects/test-determinism --max-runs 2
```

Expected: the state file is normalized and the build continues.

### End-to-end smoke test

Run a short topic that generates 2-3 scenes and completes.

---

## Files Changed / Added

- Added: `scripts/update_project_state.py`
- Added: `scripts/state_schema.json`
- Updated: `scripts/build_video.sh`
- Added: `docs/engineering/state_determinism_fix.md`
