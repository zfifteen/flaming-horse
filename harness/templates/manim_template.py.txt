"""
Flaming Horse Manim CE Scene Template (V2)

Purpose:
- Provide a high-quality full-file reference for scene construction.
- Match current local cached Qwen voice policy and locked render config.
- Demonstrate readable explainer-slide pacing with continuous visual change.

Important:
- Build-systems generation uses scaffold slots and inserts scene body only.
- This template is reference material for structure, quality, and layout choices.
"""

from pathlib import Path

from manim import *
from manim_voiceover_plus import VoiceoverScene

from flaming_horse_voice import get_speech_service
from flaming_horse.scene_helpers import (
    safe_position,
    harmonious_color,
    polished_fade_in,
    adaptive_title_position,
    safe_layout,
)
from narration_script import SCRIPT


# Python 3.13 compatibility patch (keep in generated scenes)
try:
    from typing import override as _typing_override
except Exception:
    try:
        from typing_extensions import override as _typing_override
    except Exception:
        def _typing_override(func):
            return func


# Voice cache prerequisites
REF_WAV_PATH = Path("assets/voice_ref/ref.wav")
REF_TXT_PATH = Path("assets/voice_ref/ref.txt")
if not REF_WAV_PATH.exists() or not REF_TXT_PATH.exists():
    raise FileNotFoundError("Run precache_voice.sh before building.")


# LOCKED CONFIGURATION (DO NOT MODIFY)
config.frame_height = 10
config.frame_width = 10 * 16 / 9
config.pixel_height = 1440
config.pixel_width = 2560


def clamp_text_width(text_obj, max_width=6.0):
    """
    Enforce readable text width.

    Note: set_max_width is kept for compatibility with existing validators,
    but scale_to_fit_width performs the actual visual clamp.
    """
    text_obj.set_max_width(max_width)
    if text_obj.width > max_width:
        text_obj.scale_to_fit_width(max_width)
    return text_obj


class YourSceneName(VoiceoverScene):
    """Replace with project scene class name."""

    def construct(self):
        self.set_speech_service(get_speech_service(Path(__file__).resolve().parent))

        with self.voiceover(text=SCRIPT["main"]) as tracker:
            palette = harmonious_color(BLUE, variations=4)

            # Title and subtitle contract
            title = Text(
                "How Systems Produce Results",
                font_size=48,
                weight=BOLD,
                color=palette[0],
            )
            title = adaptive_title_position(title, None)
            self.play(
                Write(title),
                run_time=min(1.2, max(0.6, tracker.duration * 0.14)),
            )

            subtitle = Text("Inputs, process, outputs", font_size=30, color=palette[1])
            clamp_text_width(subtitle, 8.2)
            subtitle.next_to(title, DOWN, buff=0.4)
            safe_position(subtitle)
            self.play(polished_fade_in(subtitle), run_time=0.8)

            # Left panel: progressive bullets
            bullet_1 = Text("Inputs shape outcomes", font_size=28, color=WHITE)
            clamp_text_width(bullet_1, 6.0)
            bullet_1.move_to(LEFT * 3.5 + UP * 1.55)
            safe_position(bullet_1)

            bullet_2 = Text("Flow creates delays", font_size=28, color=WHITE)
            clamp_text_width(bullet_2, 6.0)
            bullet_2.next_to(bullet_1, DOWN, aligned_edge=LEFT, buff=0.3)
            safe_position(bullet_2)

            bullet_3 = Text("Bottlenecks set speed", font_size=28, color=WHITE)
            clamp_text_width(bullet_3, 6.0)
            bullet_3.next_to(bullet_2, DOWN, aligned_edge=LEFT, buff=0.3)
            safe_position(bullet_3)

            self.play(
                LaggedStart(
                    FadeIn(bullet_1),
                    FadeIn(bullet_2),
                    FadeIn(bullet_3),
                    lag_ratio=0.15,
                ),
                run_time=1.2,
            )

            # Right panel: evolving process visual
            panel = RoundedRectangle(
                width=5.2,
                height=3.2,
                corner_radius=0.2,
                color=palette[2],
            ).move_to(RIGHT * 3.2 + DOWN * 0.8)
            panel_label = Text("Process View", font_size=22, color=palette[1])
            clamp_text_width(panel_label, 5.8)
            panel_label.next_to(panel, UP, buff=0.2)
            safe_position(panel_label)

            source = Circle(radius=0.27, color=GREEN, fill_opacity=1.0)
            process = RoundedRectangle(
                width=1.8,
                height=0.9,
                corner_radius=0.12,
                color=palette[0],
            )
            sink = Circle(radius=0.27, color=RED, fill_opacity=1.0)

            source.move_to(panel.get_center() + LEFT * 1.35)
            process.move_to(panel.get_center())
            sink.move_to(panel.get_center() + RIGHT * 1.35)
            safe_layout(
                source,
                process,
                sink,
                h_buff=0.85,
                max_x=7.2,
                min_x=0.1,
                max_y=2.3,
                min_y=-3.7,
            )

            source_label = Text("Input", font_size=18, color=GREEN)
            clamp_text_width(source_label, 2.0)
            source_label.next_to(source, DOWN, buff=0.16)
            safe_position(source_label)

            process_label = Text("Work", font_size=18, color=palette[0])
            clamp_text_width(process_label, 2.0)
            process_label.next_to(process, DOWN, buff=0.16)
            safe_position(process_label)

            sink_label = Text("Output", font_size=18, color=RED)
            clamp_text_width(sink_label, 2.0)
            sink_label.next_to(sink, DOWN, buff=0.16)
            safe_position(sink_label)

            flow_1 = Arrow(
                source.get_right(),
                process.get_left(),
                buff=0.08,
                stroke_width=5,
                color=palette[3],
            )
            flow_2 = Arrow(
                process.get_right(),
                sink.get_left(),
                buff=0.08,
                stroke_width=5,
                color=palette[3],
            )

            self.play(Create(panel, rate_func=smooth), FadeIn(panel_label), run_time=0.9)
            self.play(FadeIn(source), FadeIn(process), FadeIn(sink), run_time=0.7)
            self.play(Create(flow_1), Create(flow_2), run_time=0.9)
            self.play(
                FadeIn(source_label),
                FadeIn(process_label),
                FadeIn(sink_label),
                run_time=0.7,
            )

            highlight = SurroundingRectangle(process, color=YELLOW, buff=0.12)
            self.play(Create(highlight), run_time=0.5)
            self.play(FadeOut(highlight), run_time=0.5)

            # Cleanup and recap to keep layer count controlled
            self.play(FadeOut(bullet_1), FadeOut(bullet_2), FadeOut(bullet_3), run_time=0.8)

            recap = Text("Takeaway: improve the bottleneck first.", font_size=26, color=YELLOW)
            clamp_text_width(recap, 8.6)
            recap.move_to(DOWN * 3.1)
            safe_position(recap)
            self.play(
                FadeIn(recap),
                run_time=min(1.1, max(0.6, tracker.duration * 0.12)),
            )

            # Keep voiceover and visuals aligned
            self.wait(max(0.0, tracker.duration * 0.04))

            self.play(
                FadeOut(recap),
                FadeOut(source),
                FadeOut(process),
                FadeOut(sink),
                FadeOut(source_label),
                FadeOut(process_label),
                FadeOut(sink_label),
                FadeOut(flow_1),
                FadeOut(flow_2),
                FadeOut(panel),
                FadeOut(panel_label),
                FadeOut(subtitle),
                FadeOut(title),
                run_time=0.9,
            )


# Quality checklist for derived scenes:
# - Keep title at UP * 3.8 (or adaptive_title_position) and subtitle next_to title.
# - Call safe_position() after every next_to() in scene content.
# - Keep diagrams below subtitle, usually around DOWN * 0.6 to DOWN * 1.2.
# - Use MathTex for equations; do not pass weight= to MathTex or Tex.
# - Avoid external assets (SVGMobject/ImageMobject) in generated scenes.
# - Keep visible state changes every ~1.5-3.0 seconds.
