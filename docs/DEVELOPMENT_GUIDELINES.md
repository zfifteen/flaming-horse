# Development Guidelines

Date: 2026-02-13
Scope: All future coding sessions in this repository

## Purpose

This project follows a strict separation of concerns:

- Agents are for creative and reasoning-heavy work.
- Scripts are for deterministic infrastructure and enforcement.

The goal is reliability, reproducibility, and small safe changes.

## Core Principle

Prefer deterministic Python/bash scripts for anything mechanical, repetitive, or safety-critical.

Agents should not be trusted with infrastructure glue that can be scripted once and reused.

## Ownership Split

### Agent-owned (creative)

- Topic framing and narrative arc
- Scene concepts and teaching strategy
- Visual storytelling choices
- Explanatory prose in `narration_script.py`

### Script-owned (deterministic)

- Project scaffolding and file creation
- State transitions and phase progression
- Voice preparation/precache orchestration
- Scene boilerplate generation
- Timing allocation mechanics and runtime safety rules
- Contract validation (state/plan/narration/scene metadata)
- Rendering, assembly, and QC

## Timing Strategy (Mandatory)

Timing logic must be deterministic and script-owned.

Rules:

- Do not hand-author fragile timing arithmetic in scene code.
- Do not allow raw expressions that can resolve to `wait(0)` or negative durations.
- Use helper patterns generated by scaffold scripts (`play_in_slot`, `play_text_in_slot`, or equivalent).
- Compute slot timing from `tracker.duration` using deterministic rules (weights or fixed policy).

Agent role for timing:

- Provide animation order and intent only (what appears when), not low-level duration math.

## Validation Policy

Deterministic validators must gate the pipeline before expensive steps.

Minimum expectations:

- Fail fast for non-positive waits and invalid `run_time` values.
- Fail or warn on timing budget violations before render.
- Emit actionable diagnostics (file, line, rule id, suggested fix).

## One Change Per PR

To reduce risk, ship one enhancement per PR.

Each PR should:

- Have a single focused objective
- Include tests for the new behavior
- Avoid unrelated refactors
- Update docs briefly

Suggested order for this repo:

1. Runtime timing safety guardrails
2. Timing budget validation
3. Narration scaffolding
4. Cross-file contract validation
5. Positioning linting
6. Entrypoint preflight checks

## Implementation Guidance for Future Agents

When implementing changes:

- First ask: "Can this be deterministic in a script?"
- If yes, implement in Python/bash and keep agent output simple.
- Keep agent prompts focused on creative outputs, not mechanics.
- Add validators for any new failure mode discovered in production logs.

When debugging failures:

- Treat log symptoms separately from root cause.
- Convert root-cause class into a deterministic check or scaffold improvement.
- Prevent recurrence before adding new features.

## Non-Negotiable Constraints

- Keep local Qwen cached voice workflow only (no network fallback).
- Respect existing phase machine and lock semantics.
- Do not bypass validators for convenience.

## Success Criteria

This strategy is successful when:

- Builds fail early with clear deterministic errors.
- Agent creativity improves content quality without destabilizing pipeline mechanics.
- Re-runs are faster and safer due to scripted resume/validation behavior.
